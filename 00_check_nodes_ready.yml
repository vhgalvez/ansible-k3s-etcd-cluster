# 00_check_nodes_ready.yml
- name: ğŸ” Verificar que todos los nodos estÃ¡n listos para instalar K3s
  hosts: all
  become: true
  gather_facts: no

  vars:
    github_dns_target: "github.com"
    github_https_target: "https://objects.githubusercontent.com"

  tasks:
    - name: ğŸ§ª Verificar conectividad SSH (puerto 22)
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        timeout: 5
      delegate_to: localhost
      register: ssh_result
      failed_when: false
      changed_when: false

    - name: ğŸ›£ï¸ Verificar ruta por defecto (gateway)
      shell: ip route show | grep -q '^default'
      register: route_check
      failed_when: false
      changed_when: false

    - name: ğŸŒ Probar resoluciÃ³n DNS de {{ github_dns_target }}
      shell: dig +short {{ github_dns_target }}
      register: dns_check
      failed_when: false
      changed_when: false

    - name: ğŸ”— Probar conexiÃ³n HTTPS a {{ github_https_target }}
      shell: curl -sI {{ github_https_target }}
      register: curl_check
      failed_when: false
      changed_when: false

    - name: ğŸ”§ Evaluar si el nodo estÃ¡ listo
      set_fact:
        node_ready: >-
          {{
            (ssh_result is succeeded) and
            (route_check.rc == 0) and
            (dns_check.get('stdout', '') | length > 0) and
            (curl_check.rc == 0)
          }}

    - name: ğŸ“Š Reporte del estado del nodo
      debug:
        msg: |
          ğŸš€ Nodo: {{ inventory_hostname }}
          SSH accesible: {{ 'âœ…' if ssh_result is succeeded else 'âŒ' }}
          Ruta por defecto: {{ 'âœ…' if route_check.rc == 0 else 'âŒ' }}
          DNS resuelve {{ github_dns_target }}: {{ 'âœ…' if dns_check.get('stdout', '') | length > 0 else 'âŒ' }}
          HTTPS {{ github_https_target }}: {{ 'âœ…' if curl_check.rc == 0 else 'âŒ' }}

    - name: ğŸŸ¢ Nodo listo para instalar K3s
      debug:
        msg: "âœ… Nodo {{ inventory_hostname }} listo para instalar K3s."
      when: node_ready

    - name: âš ï¸ Advertencia si el nodo NO estÃ¡ completamente listo
      debug:
        msg: "âš ï¸ Nodo {{ inventory_hostname }} NO estÃ¡ completamente listo. Verifica red, DNS o salida HTTPS."
      when: not node_ready