# 00_check_nodes_ready.yml
- name: ðŸ” Verificar que todos los nodos estÃ¡n listos para instalar K3s
  hosts: all
  become: true
  gather_facts: no

  vars:
    github_dns_target: "github.com"
    github_https_target: "https://objects.githubusercontent.com"

  tasks:
    - name: ðŸ§ª Verificar conectividad SSH (puerto 22)
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        timeout: 5
      delegate_to: localhost
      register: ssh_result
      failed_when: false
      changed_when: false

    - name: ðŸ›£ï¸ Verificar ruta por defecto (gateway)
      shell: ip route show | grep -q '^default'
      register: route_check
      failed_when: false
      changed_when: false

    - name: ðŸŒ Probar resoluciÃ³n DNS de {{ github_dns_target }}
      shell: dig +short {{ github_dns_target }}
      register: dns_check
      failed_when: false
      changed_when: false

    - name: ðŸ”— Probar conexiÃ³n HTTPS a {{ github_https_target }}
      shell: curl -sI {{ github_https_target }}
      register: curl_check
      failed_when: false
      changed_when: false

    - name: ðŸ“Š Reporte final del nodo
      debug:
        msg: |
          ðŸš€ Nodo: {{ inventory_hostname }}
          SSH accesible: {{ 'âœ…' if ssh_result is succeeded else 'âŒ' }}
          Ruta por defecto: {{ 'âœ…' if route_check.rc == 0 else 'âŒ' }}
          DNS resuelve {{ github_dns_target }}: {{ 'âœ…' if dns_check.stdout | length > 0 else 'âŒ' }}
          HTTPS {{ github_https_target }}: {{ 'âœ…' if curl_check.rc == 0 else 'âŒ' }}

    - name: ðŸŸ¢ Marcar nodo como listo si todo OK
      debug:
        msg: "âœ… Nodo {{ inventory_hostname }} listo para instalar K3s."
      when:
        - ssh_result is succeeded
        - route_check.rc == 0
        - dns_check.stdout | length > 0
        - curl_check.rc == 0

    - name: âš ï¸ Advertencia si el nodo NO estÃ¡ listo
      debug:
        msg: "âš ï¸ Nodo {{ inventory_hostname }} NO estÃ¡ completamente listo. Verifica red, DNS o salida HTTPS."
      when: not (
        ssh_result is succeeded and
        route_check.rc == 0 and
        dns_check.stdout | length > 0 and
        curl_check.rc == 0
      )