# 00_check_nodes_ready.yml
---
- name: ğŸ” Verificar que todos los nodos estÃ¡n listos para instalar K3s
  hosts: all
  gather_facts: false
  become: false

  tasks:

    - name: ğŸ§ª Verificar conectividad SSH (puerto 22)
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        timeout: 5
      delegate_to: localhost

    - name: ğŸ›£ï¸ Verificar ruta por defecto (gateway)
      raw: ip route show default || true
      register: default_route_check
      changed_when: false

    - name: ğŸŒ Probar resoluciÃ³n DNS de github.com
      raw: getent hosts github.com || true
      register: dns_check
      changed_when: false

    - name: ğŸ”— Probar conexiÃ³n HTTPS a https://objects.githubusercontent.com
      raw: curl -s --max-time 5 https://objects.githubusercontent.com/ || true
      register: https_check
      changed_when: false

    - name: ğŸ”§ Evaluar si el nodo estÃ¡ listo
      set_fact:
        node_ready: >-
          {{ (
            ('default' in default_route_check.stdout | default('')) and
            ('github.com' in dns_check.stdout | default('')) and
            (https_check.stdout | length > 0)
          ) | bool }}

    - name: ğŸ“Š Reporte del estado del nodo
      debug:
        msg: |
          ğŸš€ Nodo: {{ inventory_hostname }}
          SSH accesible: âœ…
          Ruta por defecto: {{ 'âœ…' if 'default' in default_route_check.stdout | default('') else 'âŒ' }}
          DNS resuelve github.com: {{ 'âœ…' if 'github.com' in dns_check.stdout | default('') else 'âŒ' }}
          HTTPS https://objects.githubusercontent.com: {{ 'âœ…' if https_check.stdout | length > 0 else 'âŒ' }}

    - name: ğŸŸ¢ Nodo listo para instalar K3s
      debug:
        msg: "ğŸŸ¢ Nodo {{ inventory_hostname }} estÃ¡ listo para instalar K3s âœ…"
      when: node_ready

    - name: âš ï¸ Advertencia si el nodo NO estÃ¡ completamente listo
      debug:
        msg: "âš ï¸ Nodo {{ inventory_hostname }} NO estÃ¡ completamente listo. Verifica red, DNS o salida HTTPS."
      when: not node_ready